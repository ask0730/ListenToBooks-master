<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >


<mapper namespace="com.youngqi.tingshu.album.mapper.TrackInfoMapper">
    <select id="selectUserTrackPage" resultType="com.youngqi.tingshu.vo.album.TrackListVo">
        SELECT ti.album_id ,
               ti.id trackId,
               ti.track_title,
               ti.cover_url,
               ti.media_duration,
               ti.status,
               max(if(stat_type='0701', stat_num, 0)) playStatNum,
               max(if(stat_type='0702', stat_num, 0)) collectStatNum,
               max(if(stat_type='0703', stat_num, 0)) praiseStatNum,
               max(if(stat_type='0704', stat_num, 0)) commentStatNum
                FROM track_info ti LEFT JOIN  track_stat ts on ti.id=ts.track_id
                <where>
                    <if test="trackInfoQuery.userId != null">
                        ti.user_id = #{trackInfoQuery.userId}
                    </if>
                    <if test="trackInfoQuery.status != null and  trackInfoQuery.status != ''">
                        and ti.status= #{trackInfoQuery.status}
                    </if>
                    <if test="trackInfoQuery.trackTitle != null and trackInfoQuery.trackTitle != ''">
                        and ti.trackTitle like concat('%',#{trackInfoQuery.trackTitle},'%')
                    </if>
                    and ti.is_deleted = 0
                </where>
                group by ti.id
                order by ti.id desc

    </select>

    <update id="updateOrderNum">
        update track_info set order_num = order_num-1 where album_id=#{albumId} and order_num > #{orderNum} and is_deleted = 0

    </update>




</mapper>

