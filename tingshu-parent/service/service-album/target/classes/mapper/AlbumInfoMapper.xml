<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >


<mapper namespace="com.youngqi.tingshu.album.mapper.AlbumInfoMapper">
<select id="selectUserAlbumByPage" resultType="com.youngqi.tingshu.vo.album.AlbumListVo">
        SELECT  ai.id albumId,
                ai.album_title,
                ai.cover_url,
                ai.include_track_count,
                ai.is_finished,
                max(if(ast.stat_type='0401',stat_num,0)) playStatNum,
                max(if(ast.stat_type='0402',stat_num,0)) subscribeStatNum,
                max(if(ast.stat_type='0403',stat_num,0)) buyStatNum,
                max(if(ast.stat_type='0404',stat_num,0)) commentStatNum
                FROM album_info ai
                INNER JOIN album_stat ast
                ON ai.id=ast.album_id
                <where>
                    <if test="albumInfoQuery.userId !=null">
                        ai.user_id = #{albumInfoQuery.userId}
                    </if>
                    <if test="albumInfoQuery.status !=null and albumInfoQuery.status !=''">
                      and  ai.status = #{albumInfoQuery.status}
                    </if>
                    <if test="albumInfoQuery.albumTitle !=null and albumInfoQuery.albumTitle !=''">
                       and ai.album_title like concat('%',#{albumInfoQuery.albumTitle},'%')
                    </if>
                </where>
                and ai.is_deleted=0
                group by ai.id
                order by ai.id desc

</select>
    <!--     行转列   -->
    <select id="getAlbumStatVo" resultType="com.youngqi.tingshu.vo.album.AlbumStatVo">
        select
                stat.album_id,
                max(if(stat.stat_type='0401', stat.stat_num, 0)) playStatNum,
                max(if(stat.stat_type='0402', stat.stat_num, 0)) subscribeStatNum,
                max(if(stat.stat_type='0403', stat.stat_num, 0)) buyStatNum,
                max(if(stat.stat_type='0404', stat.stat_num, 0)) commentStatNum
            from album_stat stat
            where stat.album_id = #{albumId} and stat.is_deleted = 0
            group by stat.album_id
    </select>

    <!--分页获取专辑下的声音列表-->
    <select id="getAlbumTrackPage" resultType="com.youngqi.tingshu.vo.album.AlbumTrackListVo">
        select ti.id trackId,
               ti.track_title,
               ti.media_duration,
               ti.order_num,
               ti.create_time,
               max(if(ts.stat_type='0701',ts.stat_num,0)) playStatNum,
               max(if(ts.stat_type='0702', ts.stat_num, 0)) collectStatNum,
               max(if(ts.stat_type='0703', ts.stat_num, 0)) praiseStatNum,
               max(if(ts.stat_type='0704', ts.stat_num, 0)) commentStatNum
               from track_info ti
                   left join track_stat ts on ti.id=ts.track_id
                    where ti.album_id=#{albumId} and ti.is_deleted = 0
        group by  ti.id
        order by ti.order_num
    </select>
</mapper>

